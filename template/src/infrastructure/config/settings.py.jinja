"""Application settings using 12-factor app principles."""

from functools import lru_cache
from typing import Literal

from pydantic import Field, MongoDsn, RedisDsn
from pydantic_settings import BaseSettings, SettingsConfigDict


class Settings(BaseSettings):
    """Application settings loaded from environment variables."""

    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        case_sensitive=False,
        extra="ignore",
    )

    # Application
    app_name: str = Field(default="{{ project_name }}", description="Application name")
    app_version: str = Field(default="0.1.0", description="Application version")
    environment: Literal["development", "staging", "production"] = Field(
        default="development"
    )
    debug: bool = Field(default=False, description="Debug mode")
    log_level: str = Field(default="INFO", description="Logging level")

    # Server
    host: str = Field(default="0.0.0.0", description="Server host")
    port: int = Field(default={{ service_port }}, description="Server port")

    # MongoDB
    mongodb_url: MongoDsn = Field(
        default="mongodb://localhost:27017", description="MongoDB connection URL"
    )
    mongodb_database: str = Field(
        default="{{ mongodb_database }}", description="MongoDB database name"
    )
    mongodb_min_pool_size: int = Field(default=10, description="Min connection pool size")
    mongodb_max_pool_size: int = Field(default=50, description="Max connection pool size")

    # Redis
    redis_url: RedisDsn = Field(
        default="redis://localhost:6379/0", description="Redis connection URL"
    )
    redis_max_connections: int = Field(default=50, description="Redis max connections")
    redis_socket_timeout: int = Field(default=5, description="Redis socket timeout")
    redis_socket_connect_timeout: int = Field(
        default=5, description="Redis connection timeout"
    )

    # Cache
    cache_ttl: int = Field(default=300, description="Default cache TTL in seconds")
    cache_key_prefix: str = Field(
        default="{{ project_slug }}:", description="Cache key prefix"
    )

    # Rate Limiting
    rate_limit_enabled: bool = Field(default=True, description="Enable rate limiting")
    rate_limit_per_minute: int = Field(
        default=60, description="Requests per minute per IP"
    )

    # Kafka
    kafka_bootstrap_servers: str = Field(
        default="localhost:9092", description="Kafka bootstrap servers"
    )
    kafka_consumer_group: str = Field(
        default="{{ project_slug }}_consumer_group", description="Kafka consumer group"
    )
    kafka_topics: str = Field(
        default="{{ kafka_topics }}", description="Comma-separated Kafka topics"
    )
    kafka_auto_offset_reset: Literal["earliest", "latest"] = Field(
        default="earliest", description="Kafka auto offset reset"
    )
    kafka_enable_auto_commit: bool = Field(
        default=True, description="Enable Kafka auto commit"
    )
    kafka_max_poll_records: int = Field(
        default=100, description="Max records per poll"
    )

    # Schema Registry
    schema_registry_url: str = Field(
        default="http://localhost:8081", description="Schema Registry URL"
    )

    {% if use_authentication %}
    # Authentication
    jwt_secret_key: str = Field(
        default="change-this-secret-key", description="JWT secret key"
    )
    jwt_algorithm: str = Field(default="HS256", description="JWT algorithm")
    jwt_access_token_expire_minutes: int = Field(
        default=30, description="JWT expiration in minutes"
    )
    {% endif %}

    {% if use_observability %}
    # Observability
    otel_exporter_otlp_endpoint: str = Field(
        default="http://localhost:4317", description="OTLP endpoint"
    )
    otel_service_name: str = Field(
        default="{{ project_slug }}", description="Service name for tracing"
    )
    {% endif %}

    # CORS
    cors_allowed_origins: list[str] = Field(
        default=["http://localhost:3000", "http://localhost:8000"],
        description="CORS allowed origins",
    )
    cors_allow_credentials: bool = Field(
        default=True, description="CORS allow credentials"
    )
    cors_allowed_methods: list[str] = Field(
        default=["*"], description="CORS allowed methods"
    )
    cors_allowed_headers: list[str] = Field(
        default=["*"], description="CORS allowed headers"
    )

    @property
    def kafka_topics_list(self) -> list[str]:
        """Get Kafka topics as a list."""
        return [topic.strip() for topic in self.kafka_topics.split(",")]


@lru_cache
def get_settings() -> Settings:
    """Get cached settings instance."""
    return Settings()
